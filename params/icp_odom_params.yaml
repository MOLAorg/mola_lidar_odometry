# mp2p_icp ICP pipeline configuration file, for use in ICP 
# odometry and SLAM packages.
#
# YAML configuration file for use with the CLI tool mp2p-icp-run or
# programmatically from function mp2p_icp::icp_pipeline_from_yaml()
#
class_name: mp2p_icp::ICP


# See: mp2p_icp::Parameter
params:
  maxIterations: 200
  minAbsStep_trans: 1e-5
  minAbsStep_rot: 1e-5

  #debugPrintIterationProgress: true  # Print progress
  generateDebugFiles: true  # Can be override with env var "MP2P_ICP_GENERATE_DEBUG_FILES=1"
  debugFileNameFormat: "icp-logs/icp-run-${KITTI_SEQ}-$UNIQUE_ID-local_$LOCAL_ID$LOCAL_LABEL-to-global_$GLOBAL_ID$GLOBAL_LABEL.icplog"
  decimationDebugFiles: 150

solvers:
  - class: mp2p_icp::Solver_Horn
    params:
      enabled: true
      runFromIteration: 0
      runUpToIteration: 4

  - class: mp2p_icp::Solver_GaussNewton
    params:
      enabled: true
      runFromIteration: 5
      runUpToIteration: 0
      maxIterations: 2
      robustKernel: 'RobustKernel::GemanMcClure'
      robustKernelParam: 0.30 #0.10
      #innerLoopVerbose: true


# Sequence of one or more pairs (class, params) defining mp2p_icp::Matcher
# instances to pair geometric entities between pointclouds.
matchers:
  - class: mp2p_icp::Matcher_Points_DistanceThreshold
    params:
      threshold: 2.00
      #pairingsPerPoint: 3
      #maxLocalPointsPerLayer: 0  # !=0 means subsample "local" point cloud
      allowMatchAlreadyMatchedGlobalPoints: true # faster
      enabled: true
      runFromIteration: 0  # "from 0 to 0" means "all"
      runUpToIteration: 4
      pointLayerMatches:
        - {global: "voxelmap", local: "decimated_for_icp", weight: 1.0}

  - class: mp2p_icp::Matcher_Adaptive
    params:
      confidenceInterval: 0.90
      firstToSecondDistanceMax: 1.2
      absoluteMaxSearchDistance: 0.9  # m

      maxPt2PtCorrespondences: 1
      enableDetectPlanes: false
      planeSearchPoints: 8
      planeMinimumFoundPoints: 4
      planeEigenThreshold: 0.01
      
      allowMatchAlreadyMatchedGlobalPoints: true # faster
      #enabled: false
      runFromIteration: 5  # "from 0 to 0" means "all"
      runUpToIteration: 0
      pointLayerMatches:
        - {global: "voxelmap", local: "decimated_for_icp", weight: 1.0}


quality:
  - class: mp2p_icp::QualityEvaluator_PairedRatio
    params:
     reuse_icp_pairings: true
     threshold: 0.75 # ignored when 'reuse_icp_pairings'==true
     pointLayerMatches:
       - {global: "voxelmap", local: "decimated_for_icp", weight: 1.0}

